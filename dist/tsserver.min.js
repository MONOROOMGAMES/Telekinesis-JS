/*! ts 2013-06-24 */
"undefined"==typeof exports?this.tsjs={}:exports.gameClasses={},function(a){a.Scene=function(){this.actionsQeue=[],this.entityList=[],this.entityGroups={},this.entities={},this.timer={},this.nextId=0},a.Scene.ACTIONS="lotus:actions",a.Scene.HANDSHAKE="lotus:handshake",a.Scene.ADD_ENTITIES="lotus:add_entity",a.Scene.REMOVE_ENTITIES="lotus:remove_entity";var b=a.Scene.prototype;b.start=function(){this.timer=setInterval(function(){this.update.call(this)}.bind(this),33)},b.stop=function(){clearInterval(this.timer)},b.update=function(){this.processAllActions(),this.updateEntities()},b.addActionsToQeue=function(a){if("[object Array]"===Object.prototype.toString.call(a)){var b=0,c=a.length;for(b;c>b;b++)this.actionsQeue.push(a[b])}else this.actionsQeue.push(a)},b.executeAction=function(a){var b=this;void 0!==a.entityId&&(b=this.entities[a.entityId]),b&&b.actions&&b.actions.hasOwnProperty(a.actionCode)&&b.actions[a.actionCode].call(b,a),void 0!==a.syncProperties&&this.applyPropertiesToEntity(b,a.syncProperties)},b.emitAction=function(a,b,c){this.adapter.emitAction(a,b,c)},b.processAllActions=function(){var a=0,b=this.actionsQeue.length;for(a;b>a;a++)this.executeAction(this.actionsQeue[a]);this.adapter.notifyAboutActions&&this.actionsQeue.length>0&&this.adapter.notifyAboutActions(this.actionsQeue),this.actionsQeue=[]},b.addEntity=function(a){return void 0===a.id&&(a.id=this.getNewId()),this.entityList.push(a),this.entities[a.id]=a,a.group&&(void 0===this.entityGroups[a.group]&&(this.entityGroups[a.group]={}),this.entityGroups[a.group][a.id]=a),a.scene=this,void 0!==this.onAddEntities&&this.onAddEntities([a]),a},b.addEntities=function(a){var b=0,c=a.length;for(b;c>b;b++)this.addEntity(this.entityFromJSON(a[b]))},b.removeEntity=function(a){a=this.entities[a.id],this.entities[a.id]=void 0,this.entityList.splice(this.entityList.indexOf(a),1),this.entityGroups[a.group][a.id]=void 0,void 0!==this.onRemoveEntities&&this.onRemoveEntities([a])},b.removeEntityByIndex=function(a){var b=this.entityList[a];this.removeEntity(b)},b.updateEntities=function(){var a=0,b=this.entityList.length;for(a;b>a;a++)this.entityList[a].update()},b.entityFromJSON=function(a){var b=new window[a["class"]];for(var c in a)"class"!==c&&(b[c]=a[c]);return b},b.getEntitiesForTransfer=function(){var a=[],b=0,c=this.entityList.length;for(b;c>b;b++)a.push(this.getEntityForTransfer(this.entityList[b]));return a},b.getEntityForTransfer=function(a){var b={},c=0,d=a.enumerable.length;for(c;d>c;c++){var e=a.enumerable[c];void 0!==a[e]&&(b[e]=void 0!==a[e].toFixed?Math.round(100*a[e])/100:a[e])}return b},b.getNewId=function(){return this.nextId++},b.applyPropertiesToEntity=function(a,b){for(var c in b)a[c]=b[c]},b.actions={},b.actions.addEntity=function(a){console.log(a),this.addEntity(this.entityFromJSON(a.params))}}("undefined"==typeof exports?this.tsjs:exports),function(a){a.PlayerSocket=function(a,b){this._socket=a,this.server=b,this.entity={},this.setClientEventHandlers(a)};var b=a.PlayerSocket.prototype;b.setClientEventHandlers=function(){this._socket.on(a.Scene.HANDSHAKE,this.onHandshake.bind(this)),this._socket.on(a.Scene.ACTIONS,this.onAction.bind(this)),this._socket.on("disconnect",this.onDisconnect.bind(this))},b.onHandshake=function(){var b=this.server.scene.getEntitiesForTransfer();console.log(this.server.scene),this._socket.emit(a.Scene.HANDSHAKE,{playerId:this.server.scene.nextId,entities:b});var c=this.server.gameClasses[this.server.playerClass];this.entity=this.server.scene.addEntity(new c),this.server.notifyAboutActions([{actionCode:"addEntity",params:this.server.scene.getEntityForTransfer(this.entity)}]),console.log("Client handshaked with player id = "+this.entity.id+", entity with group "+this.entity.group+" added."),console.log(JSON.stringify(b))},b.onAction=function(a){a.entityId=this.entity.id,a=this.signAction(a),this.server.scene.addActionsToQeue(a)},b.onDisconnect=function(){console.log("Player "+this.entity.id+" disconnected"),this.server.scene.removeEntity(this.entity)},b.signAction=function(a){a.syncProperties={};var b=0,c=this.entity.sync.length;for(b;c>b;b++)a.syncProperties[this.entity.sync[b]]=this.entity[this.entity.sync[b]];return a}}("undefined"==typeof exports?this.tsjs:exports);var io=require("socket.io"),http=require("http"),express=require("express");!function(a){a.Server=function(b){this.init(b),this.scene=new a.Scene,this.scene.adapter=this,this.scene.start(),this.gameClasses={}},a.Server.createServer=function(b){return new a.Server(b)};var b=a.Server.prototype;b.init=function(a){this.app=express(),this.server=http.createServer(this.app),this.server.listen(a),this.socket=io.listen(this.server,{log:!1}),this.socket.sockets.on("connection",this.onConnect.bind(this)),console.log("Telekinesis server initialized on port "+a)},b.onConnect=function(b){b=new a.PlayerSocket(b,this),console.log("Socket connected with id = "+b.id)},b.emitAction=function(a,b,c){this.scene.addActionsToQeue({entityId:-1,actionCode:b,parameters:c})},b.notifyAboutActions=function(b){this.socket.sockets.emit(a.Scene.ACTIONS,b)}}("undefined"==typeof exports?this.tsjs:exports);